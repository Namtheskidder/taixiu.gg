import random
import time
import json
import os
from colorama import init, Fore, Style

init(autoreset=True)

PLAYER_FILE = "players.json"

DICE_ART = {
    1: ("â”Œâ”€â”€â”€â”€â”€â”€â”€â”", "â”‚       â”‚", "â”‚   â—   â”‚", "â”‚       â”‚", "â””â”€â”€â”€â”€â”€â”€â”€â”˜"),
    2: ("â”Œâ”€â”€â”€â”€â”€â”€â”€â”", "â”‚ â—     â”‚", "â”‚       â”‚", "â”‚     â— â”‚", "â””â”€â”€â”€â”€â”€â”€â”€â”˜"),
    3: ("â”Œâ”€â”€â”€â”€â”€â”€â”€â”", "â”‚ â—     â”‚", "â”‚   â—   â”‚", "â”‚     â— â”‚", "â””â”€â”€â”€â”€â”€â”€â”€â”˜"),
    4: ("â”Œâ”€â”€â”€â”€â”€â”€â”€â”", "â”‚ â—   â— â”‚", "â”‚       â”‚", "â”‚ â—   â— â”‚", "â””â”€â”€â”€â”€â”€â”€â”€â”˜"),
    5: ("â”Œâ”€â”€â”€â”€â”€â”€â”€â”", "â”‚ â—   â— â”‚", "â”‚   â—   â”‚", "â”‚ â—   â— â”‚", "â””â”€â”€â”€â”€â”€â”€â”€â”˜"),
    6: ("â”Œâ”€â”€â”€â”€â”€â”€â”€â”", "â”‚ â—   â— â”‚", "â”‚ â—   â— â”‚", "â”‚ â—   â— â”‚", "â””â”€â”€â”€â”€â”€â”€â”€â”˜"),
}

def in_dice(dice_values):
    dice_lines = [""] * 5
    for val in dice_values:
        art = DICE_ART[val]
        for i in range(5):
            dice_lines[i] += Fore.YELLOW + art[i] + "  "
    for line in dice_lines:
        print(line)

def roll_dice():
    return [random.randint(1, 6) for _ in range(3)]

def load_players():
    if os.path.exists(PLAYER_FILE):
        with open(PLAYER_FILE, "r") as f:
            return json.load(f)
    return {}

def save_players(players):
    with open(PLAYER_FILE, "w") as f:
        json.dump(players, f, indent=4)

def get_or_create_player(players, name):
    if name not in players:
        print(Fore.GREEN + f"ğŸ†• Táº¡o tÃ i khoáº£n má»›i cho '{name}' vá»›i 1000 xu.")
        players[name] = 1000
    else:
        print(Fore.CYAN + f"ğŸ” ÄÄƒng nháº­p: {name} | ğŸ’° Sá»‘ tiá»n hiá»‡n táº¡i: {players[name]}")
    return players[name]

def play_round(players):
    current_players = []

    while True:
        name = input("\nğŸ‘¤ Nháº­p tÃªn ngÆ°á»i chÆ¡i (hoáº·c nháº¥n Enter Ä‘á»ƒ báº¯t Ä‘áº§u): ").strip().lower()
        if name == "":
            if not current_players:
                print(Fore.RED + "â— Cáº§n Ã­t nháº¥t 1 ngÆ°á»i chÆ¡i!")
                continue
            break
        money = get_or_create_player(players, name)
        if money <= 0:
            print(Fore.RED + f"âŒ {name} Ä‘Ã£ háº¿t tiá»n.")
        else:
            current_players.append(name)

    bets = {}
    choices = {}

    for name in current_players:
        money = players[name]
        print(Fore.LIGHTBLUE_EX + f"\nğŸ‘¤ {name} | ğŸ’° {money} xu")

        while True:
            try:
                bet = int(input("ğŸ’µ Nháº­p sá»‘ tiá»n cÆ°á»£c: "))
                if bet <= 0 or bet > money:
                    print(Fore.RED + "âŒ Sá»‘ tiá»n khÃ´ng há»£p lá»‡.")
                    continue
                break
            except:
                print(Fore.RED + "âŒ Nháº­p sá»‘ há»£p lá»‡.")

        while True:
            choice = input("ğŸ¯ Chá»n TÃ i (T) hoáº·c Xá»‰u (X): ").strip().lower()
            if choice in ['t', 'x']:
                break
            else:
                print(Fore.RED + "âŒ Chá»‰ nháº­p T hoáº·c X.")

        bets[name] = bet
        choices[name] = choice

    print(Fore.MAGENTA + "\nğŸ”„ Láº¯c xÃ­ ngáº§u...")
    time.sleep(1)
    dice = roll_dice()
    total = sum(dice)

    print(Fore.YELLOW + "\nğŸ² Káº¿t quáº£:")
    in_dice(dice)
    print(Fore.LIGHTMAGENTA_EX + f"\nğŸ“Š Tá»•ng Ä‘iá»ƒm: {total} â†’ ", end="")
    result = 't' if total >= 11 else 'x'
    print(Fore.GREEN + ("TÃ€I" if result == 't' else "Xá»ˆU"))

    for name in current_players:
        if choices[name] == result:
            print(Fore.GREEN + f"âœ… {name} THáº®NG +{bets[name]} xu")
            players[name] += bets[name]
        else:
            print(Fore.RED + f"âŒ {name} THUA -{bets[name]} xu")
            players[name] -= bets[name]
    show_leaderboard(players)
    save_players(players)

def main():
    print(Fore.CYAN + Style.BRIGHT + "\n=== ğŸ² GAME TÃ€I Xá»ˆU NHIá»€U NGÆ¯á»œI CHÆ I ===")
    players = load_players()

    while True:
        play_round(players)
        again = input(Fore.LIGHTBLUE_EX + "\nğŸ” Tiáº¿p tá»¥c? (Y/N): ").strip().lower()
        if again != 'y':
            break

    print(Fore.CYAN + "\nğŸ‘‹ Káº¿t thÃºc game. Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c lÆ°u.")
def show_leaderboard(players, top=5):
    print(Fore.LIGHTYELLOW_EX + "\nğŸ† Báº¢NG Xáº¾P Háº NG:")
    sorted_players = sorted(players.items(), key=lambda x: x[1], reverse=True)
    for i, (name, money) in enumerate(sorted_players[:top], start=1):
        print(Fore.YELLOW + f"{i}. {name} - ğŸ’° {money} xu")


if __name__ == "__main__":
    main()
